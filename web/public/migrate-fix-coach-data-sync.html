<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Data Synchronization Migration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .step {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Coach Data Synchronization Migration</h1>
        
        <div class="step warning">
            <h3>‚ö†Ô∏è Important Notice</h3>
            <p>This migration fixes data inconsistencies where coach names and profile pictures are different between:</p>
            <ul>
                <li><strong>Firebase Auth Profile</strong> (updated in Settings)</li>
                <li><strong>Team Coaches Subcollection</strong> (displayed in Coaches page)</li>
                <li><strong>Team Coaches Array</strong> (used for team membership)</li>
            </ul>
            <p><strong>Make sure you're signed in as the coach whose data needs fixing!</strong></p>
        </div>

        <div class="step">
            <h3>üìã What this migration does:</h3>
            <ul>
                <li>Analyzes all teams where the current user is a coach</li>
                <li>Identifies data inconsistencies between Auth profile and team records</li>
                <li>Synchronizes display names and profile pictures across all locations</li>
                <li>Ensures future updates in Settings will sync everywhere automatically</li>
            </ul>
        </div>

        <div class="step">
            <h3>üöÄ How to run:</h3>
            <ol>
                <li>Sign in as the coach whose data needs fixing</li>
                <li>Click "Analyze Coach Data" to see current inconsistencies</li>
                <li>Click "Fix Data Inconsistencies" to synchronize everything</li>
                <li>Refresh the Coaches page to see the changes</li>
            </ol>
        </div>

        <div class="step">
            <h3>üéØ Actions:</h3>
            <button id="analyzeData" disabled>Analyze Coach Data</button>
            <button id="fixData" disabled>Fix Data Inconsistencies</button>
            <div id="status"></div>
        </div>

        <div class="step">
            <h3>üìä Output Log:</h3>
            <div id="log" class="log">Waiting for user authentication...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            updateDoc, 
            query, 
            where,
            writeBatch 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCsKFebvW1Xy7BV5XR37UCKEZID3LYzXsk",
            authDomain: "prepletix.firebaseapp.com",
            projectId: "prepletix",
            storageBucket: "prepletix.firebasestorage.app",
            messagingSenderId: "881317585520",
            appId: "1:881317585520:web:9034e8de4bcc9805a30ab5",
            measurementId: "G-X3VMVRRLVS",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM elements
        const analyzeButton = document.getElementById('analyzeData');
        const fixButton = document.getElementById('fixData');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        let currentUser = null;

        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Get all teams where the user is a coach
        async function getCoachTeams(userUid) {
            const teamsSnapshot = await getDocs(collection(db, 'teams'));
            const coachTeams = [];

            for (const teamDoc of teamsSnapshot.docs) {
                const teamData = teamDoc.data();
                const coaches = teamData.coaches || [];
                
                // Check if user is in coaches array
                const isInCoachesArray = coaches.some(coach => coach.uid === userUid);
                
                // Check if user has coach record in subcollection
                const coachesRef = collection(db, 'teams', teamDoc.id, 'coaches');
                const coachQuery = query(coachesRef, where('userId', '==', userUid));
                const coachSnapshot = await getDocs(coachQuery);
                const hasCoachRecord = !coachSnapshot.empty;

                if (isInCoachesArray || hasCoachRecord) {
                    const coachInArray = coaches.find(coach => coach.uid === userUid);
                    const coachRecord = coachSnapshot.empty ? null : {
                        id: coachSnapshot.docs[0].id,
                        ...coachSnapshot.docs[0].data()
                    };

                    coachTeams.push({
                        teamId: teamDoc.id,
                        teamName: teamData.name,
                        isInCoachesArray,
                        hasCoachRecord,
                        coachArrayData: coachInArray,
                        coachRecordData: coachRecord
                    });
                }
            }

            return coachTeams;
        }

        // Analyze coach data for inconsistencies
        async function analyzeCoachData() {
            try {
                statusDiv.innerHTML = '<div class="step">üîç Analyzing coach data...</div>';
                log('Starting coach data analysis...');

                if (!currentUser) {
                    throw new Error('No authenticated user');
                }

                log(`Analyzing data for: ${currentUser.email}`);
                log(`Auth Profile - Name: "${currentUser.displayName || 'None'}", Photo: ${currentUser.photoURL ? 'Yes' : 'No'}`);

                const coachTeams = await getCoachTeams(currentUser.uid);
                log(`Found ${coachTeams.length} teams where user is a coach`);

                let inconsistencies = 0;
                const correctName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Unknown';
                const correctPhotoURL = currentUser.photoURL || null;

                for (const team of coachTeams) {
                    log(`\n--- Team: ${team.teamName} ---`);
                    
                    if (team.isInCoachesArray) {
                        const arrayData = team.coachArrayData;
                        log(`Coaches Array - Name: "${arrayData.name}", Photo: ${arrayData.photoURL ? 'Yes' : 'No'}`);
                        
                        if (arrayData.name !== correctName || arrayData.photoURL !== correctPhotoURL) {
                            log(`‚ùå INCONSISTENCY in coaches array`);
                            inconsistencies++;
                        } else {
                            log(`‚úÖ Coaches array data is correct`);
                        }
                    }

                    if (team.hasCoachRecord) {
                        const recordData = team.coachRecordData;
                        log(`Coach Record - Name: "${recordData.name}", Photo: ${recordData.photoURL ? 'Yes' : 'No'}`);
                        
                        if (recordData.name !== correctName || recordData.photoURL !== correctPhotoURL) {
                            log(`‚ùå INCONSISTENCY in coach record`);
                            inconsistencies++;
                        } else {
                            log(`‚úÖ Coach record data is correct`);
                        }
                    }
                }

                log(`\nüìä Analysis complete: Found ${inconsistencies} inconsistencies across ${coachTeams.length} teams`);

                if (inconsistencies > 0) {
                    statusDiv.innerHTML = `<div class="step error">‚ùå Found ${inconsistencies} data inconsistencies. Click "Fix Data Inconsistencies" to resolve them.</div>`;
                } else {
                    statusDiv.innerHTML = '<div class="step success">‚úÖ All coach data is consistent! No fixes needed.</div>';
                }

            } catch (error) {
                log(`‚ùå Analysis failed: ${error.message}`);
                statusDiv.innerHTML = '<div class="step error">‚ùå Analysis failed. Check the log for details.</div>';
            }
        }

        // Fix data inconsistencies
        async function fixDataInconsistencies() {
            try {
                statusDiv.innerHTML = '<div class="step">üîß Fixing data inconsistencies...</div>';
                log('Starting data inconsistency fixes...');

                if (!currentUser) {
                    throw new Error('No authenticated user');
                }

                const coachTeams = await getCoachTeams(currentUser.uid);
                const batch = writeBatch(db);
                let fixCount = 0;

                const correctName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Unknown';
                const correctPhotoURL = currentUser.photoURL || null;

                log(`Target values - Name: "${correctName}", Photo: ${correctPhotoURL ? 'Yes' : 'No'}`);

                for (const team of coachTeams) {
                    log(`\nProcessing team: ${team.teamName}`);

                    // Fix coaches array if needed
                    if (team.isInCoachesArray) {
                        const arrayData = team.coachArrayData;
                        if (arrayData.name !== correctName || arrayData.photoURL !== correctPhotoURL) {
                            log(`üîß Fixing coaches array...`);
                            
                            const teamRef = doc(db, 'teams', team.teamId);
                            const teamDoc = await getDocs(collection(db, 'teams'));
                            const teamSnapshot = teamDoc.docs.find(doc => doc.id === team.teamId);
                            const teamData = teamSnapshot.data();
                            const coaches = teamData.coaches || [];
                            
                            const updatedCoaches = coaches.map(coach => 
                                coach.uid === currentUser.uid 
                                    ? { ...coach, name: correctName, photoURL: correctPhotoURL, updatedAt: new Date() }
                                    : coach
                            );
                            
                            batch.update(teamRef, { coaches: updatedCoaches, updatedAt: new Date() });
                            fixCount++;
                            log(`‚úÖ Queued fix for coaches array`);
                        }
                    }

                    // Fix coach record if needed
                    if (team.hasCoachRecord) {
                        const recordData = team.coachRecordData;
                        if (recordData.name !== correctName || recordData.photoURL !== correctPhotoURL) {
                            log(`üîß Fixing coach record...`);
                            
                            const coachRef = doc(db, 'teams', team.teamId, 'coaches', team.coachRecordData.id);
                            batch.update(coachRef, {
                                name: correctName,
                                photoURL: correctPhotoURL,
                                updatedAt: new Date()
                            });
                            fixCount++;
                            log(`‚úÖ Queued fix for coach record`);
                        }
                    }
                }

                if (fixCount > 0) {
                    log(`\nüíæ Committing ${fixCount} fixes to database...`);
                    await batch.commit();
                    log(`‚úÖ Successfully fixed ${fixCount} data inconsistencies!`);
                    statusDiv.innerHTML = `<div class="step success">üéâ Fixed ${fixCount} data inconsistencies! Refresh your app to see changes.</div>`;
                } else {
                    log(`‚ÑπÔ∏è No fixes needed - all data is already consistent`);
                    statusDiv.innerHTML = '<div class="step success">‚ÑπÔ∏è No fixes needed - all data is already consistent!</div>';
                }

            } catch (error) {
                log(`‚ùå Fix failed: ${error.message}`);
                console.error('Fix error:', error);
                statusDiv.innerHTML = '<div class="step error">‚ùå Fix failed. Check the log for details.</div>';
            }
        }

        // Event listeners
        analyzeButton.addEventListener('click', analyzeCoachData);
        fixButton.addEventListener('click', fixDataInconsistencies);

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                log(`‚úÖ Authenticated as: ${user.email}`);
                log(`Display Name: "${user.displayName || 'Not set'}"`);
                log(`Profile Photo: ${user.photoURL ? 'Available' : 'Not available'}`);
                log('Ready to analyze coach data.\n');
                
                statusDiv.innerHTML = `<div class="step success">‚úÖ Authenticated as: ${user.email}</div>`;
                analyzeButton.disabled = false;
                fixButton.disabled = false;
            } else {
                currentUser = null;
                log('‚ùå Not authenticated. Please sign in to your Prepletix app first.');
                statusDiv.innerHTML = '<div class="step warning">‚ö†Ô∏è Not authenticated. Please sign in to your Prepletix app first.</div>';
                analyzeButton.disabled = true;
                fixButton.disabled = true;
            }
        });

        // Make functions available globally for console use
        window.analyzeCoachData = analyzeCoachData;
        window.fixDataInconsistencies = fixDataInconsistencies;

        log('üîß Coach Data Synchronization Migration Script Loaded');
        log('üëâ You can also run analyzeCoachData() or fixDataInconsistencies() directly from the console\n');
    </script>
</body>
</html>